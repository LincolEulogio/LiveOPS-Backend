generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Action {
  id         String   @id @default(uuid()) @db.Uuid
  ruleId     String   @db.Uuid
  actionType String
  payload    Json?
  order      Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  rule       Rule     @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@index([ruleId])
}

model AuditLog {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String?  @db.Uuid
  action    String
  details   Json?
  ipAddress String?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])

  @@index([action])
  @@index([userId])
}

model ChatMessage {
  id           String     @id @default(uuid()) @db.Uuid
  productionId String     @db.Uuid
  userId       String?    @db.Uuid
  message      String
  createdAt    DateTime   @default(now())
  production   Production @relation(fields: [productionId], references: [id], onDelete: Cascade)
  user         User?      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([productionId])
  @@index([userId])
}

model Command {
  id           String            @id @default(uuid()) @db.Uuid
  productionId String            @db.Uuid
  senderId     String            @db.Uuid
  targetRoleId String?           @db.Uuid
  targetUserId String?           @db.Uuid
  templateId   String?           @db.Uuid
  message      String
  requiresAck  Boolean           @default(true)
  status       String            @default("SENT")
  createdAt    DateTime          @default(now())
  production   Production        @relation(fields: [productionId], references: [id], onDelete: Cascade)
  sender       User              @relation(fields: [senderId], references: [id], onDelete: Cascade)
  targetRole   Role?             @relation(fields: [targetRoleId], references: [id])
  targetUser   User?             @relation("CommandTarget", fields: [targetUserId], references: [id])
  template     CommandTemplate?  @relation(fields: [templateId], references: [id])
  responses    CommandResponse[]

  @@index([productionId])
  @@index([senderId])
  @@index([targetRoleId])
  @@index([targetUserId])
}

model CommandResponse {
  id          String   @id @default(uuid()) @db.Uuid
  commandId   String   @db.Uuid
  responderId String   @db.Uuid
  response    String
  note        String?
  createdAt   DateTime @default(now())
  command     Command  @relation(fields: [commandId], references: [id], onDelete: Cascade)
  responder   User     @relation(fields: [responderId], references: [id], onDelete: Cascade)

  @@index([commandId])
  @@index([responderId])
}

model CommandTemplate {
  id             String          @id @default(uuid()) @db.Uuid
  productionId   String          @db.Uuid
  name           String
  description    String?
  icon           String?
  color          String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  commands       Command[]
  production     Production      @relation(fields: [productionId], references: [id], onDelete: Cascade)
  timelineBlocks TimelineBlock[]

  @@index([productionId])
}

model DeviceSession {
  id             String     @id @default(uuid()) @db.Uuid
  socketId       String     @unique
  userId         String     @db.Uuid
  productionId   String     @db.Uuid
  isOnline       Boolean    @default(true)
  connectedAt    DateTime   @default(now())
  disconnectedAt DateTime?
  production     Production @relation(fields: [productionId], references: [id], onDelete: Cascade)
  user           User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([isOnline])
  @@index([productionId])
  @@index([userId])
}

model ObsConnection {
  id           String     @id @default(uuid()) @db.Uuid
  productionId String     @unique @db.Uuid
  url          String
  password     String?
  isEnabled    Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  production   Production @relation(fields: [productionId], references: [id], onDelete: Cascade)
}

model OperatorActivity {
  id           String   @id @default(uuid()) @db.Uuid
  userId       String   @db.Uuid
  productionId String   @db.Uuid
  action       String
  details      Json?
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([productionId])
  @@index([userId])
}

model Permission {
  id              String           @id @default(uuid()) @db.Uuid
  action          String           @unique
  description     String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  rolePermissions RolePermission[]
}

model Production {
  id               String            @id @default(uuid()) @db.Uuid
  name             String
  description      String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  deletedAt        DateTime?
  engineType       EngineType        @default(OBS)
  status           ProductionStatus  @default(DRAFT)
  chatMessages     ChatMessage[]
  commands         Command[]
  commandTemplates CommandTemplate[]
  deviceSessions   DeviceSession[]
  obsConnection    ObsConnection?
  logs             ProductionLog[]
  script           ProductionScript?
  users            ProductionUser[]
  rules            Rule[]
  timelineBlocks   TimelineBlock[]
  vmixConnection   VmixConnection?

  @@index([deletedAt])
  @@index([status])
}

model ProductionLog {
  id           String     @id @default(uuid()) @db.Uuid
  productionId String     @db.Uuid
  eventType    String
  details      Json?
  createdAt    DateTime   @default(now())
  production   Production @relation(fields: [productionId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([eventType])
  @@index([productionId])
}

model ProductionScript {
  id           String     @id @default(uuid()) @db.Uuid
  productionId String     @unique @db.Uuid
  content      Bytes
  updatedAt    DateTime   @updatedAt
  production   Production @relation(fields: [productionId], references: [id], onDelete: Cascade)
}

model ProductionUser {
  userId       String     @db.Uuid
  productionId String     @db.Uuid
  roleId       String     @db.Uuid
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  production   Production @relation(fields: [productionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id])
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, productionId])
  @@index([productionId])
  @@index([userId])
}

model Role {
  id              String           @id @default(uuid()) @db.Uuid
  name            String           @unique
  description     String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  commands        Command[]
  productionUsers ProductionUser[]
  permissions     RolePermission[]
  users           User[]
}

model RolePermission {
  roleId       String     @db.Uuid
  permissionId String     @db.Uuid
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@index([permissionId])
  @@index([roleId])
}

model Rule {
  id            String             @id @default(uuid()) @db.Uuid
  productionId  String             @db.Uuid
  name          String
  description   String?
  isEnabled     Boolean            @default(true)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  actions       Action[]
  production    Production         @relation(fields: [productionId], references: [id], onDelete: Cascade)
  executionLogs RuleExecutionLog[]
  triggers      Trigger[]

  @@index([isEnabled])
  @@index([productionId])
}

model RuleExecutionLog {
  id           String   @id @default(uuid()) @db.Uuid
  ruleId       String   @db.Uuid
  productionId String   @db.Uuid
  status       String
  details      String?
  createdAt    DateTime @default(now())
  rule         Rule     @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@index([productionId])
  @@index([ruleId])
}

model Session {
  id           String   @id @default(uuid()) @db.Uuid
  userId       String   @db.Uuid
  refreshToken String   @unique
  expiresAt    DateTime
  isRevoked    Boolean  @default(false)
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([refreshToken])
  @@index([userId])
}

model TimelineBlock {
  id                 String           @id @default(uuid()) @db.Uuid
  productionId       String           @db.Uuid
  title              String
  description        String?
  durationMs         Int              @default(0)
  status             BlockStatus      @default(PENDING)
  order              Int              @default(0)
  linkedScene        String?
  source             String?
  intercomTemplateId String?          @db.Uuid
  startTime          DateTime?
  endTime            DateTime?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  intercomTemplate   CommandTemplate? @relation(fields: [intercomTemplateId], references: [id])
  production         Production       @relation(fields: [productionId], references: [id], onDelete: Cascade)

  @@index([productionId])
}

model Trigger {
  id        String   @id @default(uuid()) @db.Uuid
  ruleId    String   @db.Uuid
  eventType String
  condition Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  rule      Rule     @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@index([ruleId])
}

model User {
  id                 String             @id @default(uuid()) @db.Uuid
  email              String             @unique
  password           String
  name               String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  deletedAt          DateTime?
  globalRoleId       String?            @db.Uuid
  auditLogs          AuditLog[]
  chatMessages       ChatMessage[]
  commands           Command[]
  responses          CommandResponse[]
  deviceSessions     DeviceSession[]
  operatorActivities OperatorActivity[]
  productions        ProductionUser[]
  sessions           Session[]
  globalRole         Role?              @relation(fields: [globalRoleId], references: [id])

  receivedCommands Command[] @relation("CommandTarget")

  @@index([deletedAt])
  @@index([email])
}

model VmixConnection {
  id              String     @id @default(uuid()) @db.Uuid
  productionId    String     @unique @db.Uuid
  url             String
  isEnabled       Boolean    @default(true)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  pollingInterval Int        @default(500)
  production      Production @relation(fields: [productionId], references: [id], onDelete: Cascade)
}

enum BlockStatus {
  PENDING
  ACTIVE
  COMPLETED
}

enum EngineType {
  OBS
  VMIX
}

enum ProductionStatus {
  SETUP
  ACTIVE
  ARCHIVED
  DRAFT
}
