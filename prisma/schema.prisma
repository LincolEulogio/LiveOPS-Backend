generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id       String  @id @default(uuid()) @db.Uuid
  email    String  @unique
  password String
  name     String?

  // Relations
  sessions    Session[]
  productions ProductionUser[]
  auditLogs   AuditLog[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Soft Delete
  deletedAt DateTime?

  // Performance Indexes
  @@index([email])
  @@index([deletedAt])
}

model Role {
  id          String  @id @default(uuid()) @db.Uuid
  name        String  @unique // e.g., 'ADMIN', 'OPERATOR', 'VIEWER'
  description String?

  // Relations
  permissions RolePermission[]
  users       ProductionUser[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Permission {
  id          String  @id @default(uuid()) @db.Uuid
  action      String  @unique // e.g., 'production:create', 'scene:switch'
  description String?

  // Relations
  roles RolePermission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model RolePermission {
  roleId       String @db.Uuid
  permissionId String @db.Uuid

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

model Production {
  id          String  @id @default(uuid()) @db.Uuid
  name        String
  description String?
  status      String  @default("DRAFT") // DRAFT, LIVE, FINISHED

  // Relations
  users ProductionUser[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([status])
  @@index([deletedAt])
}

model ProductionUser {
  userId       String @db.Uuid
  productionId String @db.Uuid
  roleId       String @db.Uuid

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  production Production @relation(fields: [productionId], references: [id], onDelete: Cascade)
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Restrict)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@id([userId, productionId])
  @@index([userId])
  @@index([productionId])
}

model Session {
  id           String   @id @default(uuid()) @db.Uuid
  userId       String   @db.Uuid
  refreshToken String   @unique
  expiresAt    DateTime
  isRevoked    Boolean  @default(false)
  ipAddress    String?
  userAgent    String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([refreshToken])
}

model AuditLog {
  id        String  @id @default(uuid()) @db.Uuid
  userId    String? @db.Uuid
  action    String
  details   Json?
  ipAddress String?

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
}
